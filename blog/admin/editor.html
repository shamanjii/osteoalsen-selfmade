if (result.success) {
                    allImages = result.data.media || [];
                    displayImagePicker(allImages);
                } else {
                    showImagePickerError('Fehler beim Laden der Bilder: ' + result.error);
                }
            } catch (error) {
                console.error('Load images error:', error);
                showImagePickerError('Fehler beim Laden der Bilder');
            }
        }

        function displayImagePicker(images) {
            const container = document.getElementById('imagePickerGrid');
            
            if (images.length === 0) {
                container.innerHTML = `
                    <div class="image-picker-empty">
                        <i class="fas fa-images"></i>
                        <h3>Keine Bilder vorhanden</h3>
                        <p>Laden Sie Ihre ersten Bilder hoch!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = images.map(image => `
                <div class="image-picker-item" onclick="selectImage('${image.id}')" data-image-id="${image.id}">
                    <img class="image-picker-thumbnail" 
                         src="${image.thumbnail_url || image.url}" 
                         alt="${image.alt_text || image.name}"
                         loading="lazy">
                    <div class="image-picker-info">
                        <div class="image-picker-name">${escapeHtml(image.name)}</div>
                        <div class="image-picker-meta">${formatFileSize(image.size)}</div>
                    </div>
                </div>
            `).join('');
        }

        function selectImage(imageId) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.image-picker-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Neue Auswahl
            const imageItem = document.querySelector(`[data-image-id="${imageId}"]`);
            if (imageItem) {
                imageItem.classList.add('selected');
                selectedImageData = allImages.find(img => img.id === imageId);
                document.getElementById('selectImageBtn').disabled = false;
            }
        }

        function selectPickedImage() {
            if (!selectedImageData || !currentImageInputId) return;

            const input = document.getElementById(currentImageInputId);
            input.value = selectedImageData.url;
            
            // Trigger change event für Preview
            input.dispatchEvent(new Event('input'));
            
            closeImagePicker();
            showMessage('Bild ausgewählt', 'success');
        }

        function filterImagePicker() {
            const search = document.getElementById('imagePickerSearch').value.toLowerCase();
            
            const filteredImages = allImages.filter(image => 
                image.name.toLowerCase().includes(search) ||
                (image.alt_text && image.alt_text.toLowerCase().includes(search))
            );
            
            displayImagePicker(filteredImages);
        }

        function refreshImagePicker() {
            loadImagePicker();
        }

        function triggerImageUpload() {
            document.getElementById('imagePickerUpload').click();
        }

        async function handleImagePickerUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            showMessage('Bilder werden hochgeladen...', 'info');

            try {
                for (const file of files) {
                    await uploadImageFile(file);
                }
                
                showMessage('Bilder erfolgreich hochgeladen', 'success');
                await loadImagePicker();
                
            } catch (error) {
                console.error('Upload error:', error);
                showMessage('Fehler beim Hochladen: ' + error.message, 'error');
            }

            // Input zurücksetzen
            e.target.value = '';
        }

        async function uploadImageFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('action', 'upload');

            const response = await fetch('../api/media.php', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Upload fehlgeschlagen');
            }

            return result;
        }

        function showImagePickerError(message) {
            const container = document.getElementById('imagePickerGrid');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        // TinyMCE Image Integration
        function setupTinyMCEImageIntegration() {
            if (editor) {
                // Custom Image Button für TinyMCE
                editor.ui.registry.addButton('customimage', {
                    icon: 'image',
                    tooltip: 'Bild aus Medien einfügen',
                    onAction: function() {
                        openTinyMCEImagePicker();
                    }
                });

                // Toolbar erweitern
                const toolbar = editor.settings.toolbar;
                if (toolbar && !toolbar.includes('customimage')) {
                    editor.settings.toolbar = toolbar.replace('image', 'customimage image');
                }
            }
        }

        async function openTinyMCEImagePicker() {
            currentImageInputId = 'tinymce';
            selectedImageData = null;
            
            document.getElementById('imagePickerModal').classList.add('show');
            document.getElementById('selectImageBtn').disabled = true;
            
            // Button-Text ändern
            document.getElementById('selectImageBtn').innerHTML = '<i class="fas fa-plus"></i> Bild einfügen';
            
            await loadImagePicker();
        }

        function insertImageIntoTinyMCE() {
            if (!selectedImageData || !editor) return;

            const imageHtml = `<img src="${selectedImageData.url}" alt="${selectedImageData.alt_text || ''}" title="${selectedImageData.title || ''}" style="max-width: 100%; height: auto;">`;
            
            editor.insertContent(imageHtml);
            closeImagePicker();
            
            // Button-Text zurücksetzen
            document.getElementById('selectImageBtn').innerHTML = '<i class="fas fa-check"></i> Bild auswählen';
            
            showMessage('Bild eingefügt', 'success');
        }

        // Override selectPickedImage für TinyMCE
        const originalSelectPickedImage = selectPickedImage;
        selectPickedImage = function() {
            if (currentImageInputId === 'tinymce') {
                insertImageIntoTinyMCE();
            } else {
                originalSelectPickedImage();
            }
        };

        function updateSEOAnalysis() {
            setTimeout(updateSEOScores, 100);
        }

        // Image Management Functions
        function updateImagePreview() {
            const imageUrl = document.getElementById('featuredImage').value;
            const preview = document.getElementById('featuredImagePreview');
            const img = document.getElementById('featuredImageImg');

            if (imageUrl) {
                img.src = imageUrl;
                img.onload = () => {
                    preview.style.display = 'block';
                };
                img.onerror = () => {
                    preview.style.display = 'none';
                };
            } else {
                preview.style.display = 'none';
            }
        }

        function clearImage(inputId) {
            document.getElementById(inputId).value = '';
            document.getElementById(inputId + 'Preview').style.display = 'none';
        }

        async function openImagePicker(inputId) {
            currentImageInputId = inputId;
            selectedImageData = null;
            
            document.getElementById('imagePickerModal').classList.add('show');
            document.getElementById('selectImageBtn').disabled = true;
            
            await loadImagePicker();
        }

        function closeImagePicker() {
            document.getElementById('imagePickerModal').classList.remove('show');
            currentImageInputId = null;
            selectedImageData = null;
        }

        async function loadImagePicker() {
            try {
                const response = await fetch('../api/media.php?action=list&limit=100');
                const result = await response.json();

                if (result.success) {
                    <!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Editor - Blog CMS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.8.2/tinymce.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
        }

        .editor-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .section-header {
            background: #f1f5f9;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .form-group:last-child {
            border-bottom: none;
        }

        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #475569;
        }

        input[type="text"], 
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .char-count {
            font-size: 0.875rem;
            color: #64748b;
            text-align: right;
            margin-top: 0.25rem;
        }

        .char-count.warning {
            color: #f59e0b;
        }

        .char-count.error {
            color: #ef4444;
        }

        .tag-input-container {
            position: relative;
        }

        .tags-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .tag {
            background: #667eea;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .editor-container {
            min-height: 400px;
        }

        .preview-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .seo-preview {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .google-preview {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            background: #fafafa;
        }

        .google-title {
            color: #1a0dab;
            font-size: 1.125rem;
            font-weight: 400;
            text-decoration: underline;
            margin-bottom: 0.25rem;
            cursor: pointer;
        }

        .google-url {
            color: #006621;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .google-description {
            color: #545454;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .seo-score {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .score-item {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: #f8fafc;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .score-label {
            font-size: 0.875rem;
            color: #64748b;
        }

        .score-good { color: #10b981; }
        .score-warning { color: #f59e0b; }
        .score-error { color: #ef4444; }

        .publish-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .publish-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .live-preview {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .preview-content {
            padding: 1.5rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .preview-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .preview-meta {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
        }

        .preview-body {
            line-height: 1.7;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-draft {
            background: #fef3c7;
            color: #92400e;
        }

        .status-published {
            background: #d1fae5;
            color: #065f46;
        }

        .image-input-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .image-input-container input {
            flex: 1;
        }

        .image-preview {
            text-align: center;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        /* Image Picker Modal */
        .image-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .image-picker-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-picker-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .image-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 1rem;
        }

        .image-picker-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .image-picker-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        .image-picker-toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .image-picker-search {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .image-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .image-picker-item {
            border: 2px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .image-picker-item:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
        }

        .image-picker-item.selected {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .image-picker-thumbnail {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: linear-gradient(45deg, #f1f5f9 25%, transparent 25%), 
                        linear-gradient(-45deg, #f1f5f9 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f1f5f9 75%), 
                        linear-gradient(-45deg, transparent 75%, #f1f5f9 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        .image-picker-info {
            padding: 0.75rem;
        }

        .image-picker-name {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            word-break: break-word;
        }

        .image-picker-meta {
            font-size: 0.75rem;
            color: #64748b;
        }

        .image-picker-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }

        .image-picker-upload {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .image-picker-upload:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .image-picker-upload-icon {
            font-size: 2rem;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        .image-picker-loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .image-picker-empty {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .image-picker-content {
                width: 95%;
                padding: 1rem;
            }

            .image-picker-toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .image-picker-search {
                min-width: auto;
            }

            .image-picker-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }

            .image-picker-actions {
                flex-direction: column;
            }
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #dc2626;
        }

        .success-message {
            background: #f0fdf4;
            color: #166534;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid #16a34a;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1><i class="fas fa-edit"></i> Post Editor</h1>
<nav>
    <a href="../index.html" class="logo">
        <div class="logo-icon">OA</div>
        <div class="logo-text">
            <div class="logo-title">Osteopathie Alsen</div>
            <div class="logo-subtitle">CMS Dashboard</div>
        </div>
    </a>
    <ul class="nav-menu" id="navMenu">
        <li><a href="index.html">📊 Dashboard</a></li>
        <li><a href="editor.html" class="active">✏️ Editor</a></li>
        <li><a href="media.html">🖼️ Medien</a></li>
        <li><a href="seo.html">🔍 SEO-Tools</a></li>
        <li><a href="content-optimizer.html">🎯 Optimierer</a></li>
        <li><a href="automation.html">🤖 Automatisierung</a></li>
        <li><a href="performance.html">⚡ Performance</a></li>
        <li><a href="analytics.html">📈 Analytics</a></li>
        <li><a href="content-workflow.html">📝 Workflow</a></li>
        <li><a href="../index.html" class="nav-cta">🌐 Blog ansehen</a></li>
    </ul>
    <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
</nav>
    </header>

    <div class="container">
        <!-- Hauptbereich - Editor -->
        <div class="editor-main">
            <form id="postForm">
                <!-- Basis-Informationen -->
                <div class="editor-section">
                    <div class="section-header">
                        <i class="fas fa-info-circle"></i>
                        Artikel-Informationen
                    </div>
                    
                    <div class="form-group">
                        <label for="title">Titel *</label>
                        <input type="text" id="title" name="title" required maxlength="60">
                        <div class="char-count" id="titleCount">0/60 Zeichen</div>
                    </div>

                    <div class="form-group">
                        <label for="slug">URL-Slug (automatisch generiert)</label>
                        <input type="text" id="slug" name="slug">
                    </div>

                    <div class="form-group">
                        <label for="excerpt">Kurzbeschreibung/Excerpt</label>
                        <textarea id="excerpt" name="excerpt" rows="3" maxlength="160" placeholder="Kurze Zusammenfassung für Suchmaschinen und Social Media"></textarea>
                        <div class="char-count" id="excerptCount">0/160 Zeichen</div>
                    </div>

                    <div class="form-group">
                        <label for="category">Kategorie</label>
                        <select id="category" name="category">
                            <option value="">Kategorie wählen</option>
                            <option value="technologie">Technologie</option>
                            <option value="business">Business</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="tutorial">Tutorial</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tags">Tags (Enter zum Hinzufügen)</label>
                        <div class="tag-input-container">
                            <div class="tags-display" id="tagsDisplay"></div>
                            <input type="text" id="tagInput" placeholder="Tag eingeben und Enter drücken">
                        </div>
                        <input type="hidden" id="tags" name="tags">
                    </div>

                    <div class="form-group">
                        <label for="featuredImage">Hauptbild</label>
                        <div class="image-input-container">
                            <input type="url" id="featuredImage" name="featuredImage" placeholder="Bild-URL oder aus Medien wählen">
                            <button type="button" class="btn btn-secondary" onclick="openImagePicker('featuredImage')">
                                <i class="fas fa-images"></i> Aus Medien wählen
                            </button>
                        </div>
                        <div class="image-preview" id="featuredImagePreview" style="display: none;">
                            <img id="featuredImageImg" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 0.5rem;">
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearImage('featuredImage')" style="margin-top: 0.5rem;">
                                <i class="fas fa-times"></i> Entfernen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Content Editor -->
                <div class="editor-section">
                    <div class="section-header">
                        <i class="fas fa-edit"></i>
                        Artikel-Inhalt
                    </div>
                    
                    <div class="form-group">
                        <div class="editor-container">
                            <textarea id="content" name="content"></textarea>
                        </div>
                    </div>
                </div>

                <!-- SEO Einstellungen -->
                <div class="editor-section">
                    <div class="section-header">
                        <i class="fas fa-search"></i>
                        SEO-Einstellungen
                    </div>
                    
                    <div class="form-group">
                        <label for="metaTitle">Meta Title (falls abweichend vom Haupttitel)</label>
                        <input type="text" id="metaTitle" name="metaTitle" maxlength="60">
                        <div class="char-count" id="metaTitleCount">0/60 Zeichen</div>
                    </div>

                    <div class="form-group">
                        <label for="metaDescription">Meta Description</label>
                        <textarea id="metaDescription" name="metaDescription" rows="3" maxlength="160" placeholder="Beschreibung für Suchmaschinen"></textarea>
                        <div class="char-count" id="metaDescCount">0/160 Zeichen</div>
                    </div>

                    <div class="form-group">
                        <label for="focusKeyword">Focus Keyword</label>
                        <input type="text" id="focusKeyword" name="focusKeyword" placeholder="Haupt-Keyword für SEO-Analyse">
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar - Preview & Tools -->
        <div class="preview-section">
            <!-- Publishing -->
            <div class="publish-section">
                <h3><i class="fas fa-rocket"></i> Veröffentlichung</h3>
                
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="draft">Entwurf</option>
                        <option value="published">Veröffentlicht</option>
                        <option value="scheduled">Geplant</option>
                    </select>
                </div>

                <div class="form-group" id="publishDateGroup" style="display: none;">
                    <label for="publishDate">Veröffentlichungsdatum</label>
                    <input type="datetime-local" id="publishDate" name="publishDate">
                </div>

                <div class="publish-buttons">
                    <button type="button" class="btn btn-secondary" id="saveDraftBtn">
                        <i class="fas fa-save"></i> Entwurf speichern
                    </button>
                    <button type="button" class="btn btn-primary" id="publishBtn">
                        <i class="fas fa-rocket"></i> Veröffentlichen
                    </button>
                </div>

                <div id="saveStatus"></div>
            </div>

            <!-- SEO Preview -->
            <div class="seo-preview">
                <h3><i class="fas fa-search"></i> SEO-Vorschau</h3>
                
                <div class="google-preview">
                    <div class="google-title" id="previewTitle">Ihr Artikel-Titel</div>
                    <div class="google-url" id="previewUrl">https://ihreblog.de/artikel-url</div>
                    <div class="google-description" id="previewDescription">Ihre Meta-Description wird hier angezeigt...</div>
                </div>

                <div class="seo-score">
                    <div class="score-item">
                        <div class="score-value score-good" id="titleScore">0</div>
                        <div class="score-label">Titel</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value score-good" id="contentScore">0</div>
                        <div class="score-label">Inhalt</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value score-good" id="seoScore">0</div>
                        <div class="score-label">SEO</div>
                    </div>
                </div>
            </div>

            <!-- Live Preview -->
            <div class="live-preview">
                <div class="section-header">
                    <i class="fas fa-eye"></i>
                    Live-Vorschau
                </div>
                <div class="preview-content">
                    <h1 class="preview-title" id="liveTitle">Artikel-Titel</h1>
                    <div class="preview-meta">
                        <span id="liveDate">Heute</span>
                        <span id="liveCategory">Kategorie</span>
                        <span class="status-indicator status-draft" id="liveStatus">
                            <i class="fas fa-edit"></i> Entwurf
                        </span>
                    </div>
                    <div class="preview-body" id="liveContent">
                        <p>Ihr Artikel-Inhalt wird hier in Echtzeit angezeigt...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Picker Modal -->
    <div id="imagePickerModal" class="image-picker-modal">
        <div class="image-picker-content">
            <div class="image-picker-header">
                <div class="image-picker-title">Medien auswählen</div>
                <button type="button" class="image-picker-close" onclick="closeImagePicker()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="image-picker-toolbar">
                <input type="text" id="imagePickerSearch" class="image-picker-search" placeholder="Suchen...">
                <button type="button" class="btn btn-secondary" onclick="refreshImagePicker()">
                    <i class="fas fa-sync-alt"></i> Aktualisieren
                </button>
                <button type="button" class="btn btn-primary" onclick="triggerImageUpload()">
                    <i class="fas fa-upload"></i> Hochladen
                </button>
            </div>
            <div class="image-picker-grid" id="imagePickerGrid">
                <div class="image-picker-loading">Lade Bilder...</div>
            </div>
            <div class="image-picker-actions">
                <button type="button" class="btn btn-secondary" onclick="closeImagePicker()">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
                <button type="button" class="btn btn-primary" id="selectImageBtn" onclick="selectPickedImage()" disabled>
                    <i class="fas fa-check"></i> Bild auswählen
                </button>
            </div>
            <input type="file" id="imagePickerUpload" multiple style="display:none;">
        </div>
    </div>

    <script>
        // Globale Variablen
        let editor;
        let currentTags = [];
        let isEditing = false;
        let currentPostId = null;
        let currentImageInputId = null;
        let selectedImageData = null;
        let allImages = [];

        // URL Parameter prüfen (für Edit-Modus)
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');

        // TinyMCE Editor initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            tinymce.init({
                selector: '#content',
                height: 400,
                menubar: false,
                plugins: [
                    'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                    'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                    'insertdatetime', 'media', 'table', 'help', 'wordcount'
                ],
                toolbar: 'undo redo | blocks | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | link customimage media | code preview fullscreen',
                content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 16px; line-height: 1.6; }',
                branding: false,
                promotion: false,
                setup: function(ed) {
                    editor = ed;
                    ed.on('input', updateLivePreview);
                    ed.on('change', updateLivePreview);
                    ed.on('init', function() {
                        setupTinyMCEImageIntegration();
                        updateImagePreview(); // Initial image preview
                    });
                },
                images_upload_handler: function(blobInfo, success, failure) {
                    // Upload über Media API
                    const formData = new FormData();
                    formData.append('file', blobInfo.blob(), blobInfo.filename());
                    formData.append('action', 'upload');

                    fetch('../api/media.php', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            success(result.data.media.url);
                        } else {
                            failure('Upload fehlgeschlagen: ' + result.error);
                        }
                    })
                    .catch(error => {
                        failure('Upload-Fehler: ' + error.message);
                    });
                },
                automatic_uploads: false
            });

            // Event Listeners
            setupEventListeners();
            
            // Lade Post wenn Edit-Modus
            if (editId) {
                loadPostForEditing(editId);
            }

            // Initial Preview Update
            setTimeout(updateLivePreview, 1000);
        });

        function setupEventListeners() {
            // Titel Änderungen
            document.getElementById('title').addEventListener('input', function() {
                updateCharCount('title', 'titleCount', 60);
                updateSlug();
                updateSEOPreview();
                updateLivePreview();
            });

            // Excerpt Änderungen
            document.getElementById('excerpt').addEventListener('input', function() {
                updateCharCount('excerpt', 'excerptCount', 160);
                updateSEOPreview();
            });

            // Meta-Felder
            document.getElementById('metaTitle').addEventListener('input', function() {
                updateCharCount('metaTitle', 'metaTitleCount', 60);
                updateSEOPreview();
            });

            document.getElementById('metaDescription').addEventListener('input', function() {
                updateCharCount('metaDescription', 'metaDescCount', 160);
                updateSEOPreview();
            });

            // Tag Input
            document.getElementById('tagInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag(this.value.trim());
                    this.value = '';
                }
            });

            // Kategorie Änderung
            document.getElementById('category').addEventListener('change', updateLivePreview);

            // Status Änderung
            document.getElementById('status').addEventListener('change', function() {
                const publishDateGroup = document.getElementById('publishDateGroup');
                if (this.value === 'scheduled') {
                    publishDateGroup.style.display = 'block';
                } else {
                    publishDateGroup.style.display = 'none';
                }
                updateLivePreview();
            });

            // Save & Publish Buttons
            document.getElementById('saveDraftBtn').addEventListener('click', () => savePost('draft'));
            document.getElementById('publishBtn').addEventListener('click', () => savePost('published'));

            // Focus Keyword
            document.getElementById('focusKeyword').addEventListener('input', updateSEOAnalysis);

            // Featured Image URL Änderung
            document.getElementById('featuredImage').addEventListener('input', updateImagePreview);

            // Image Picker Upload
            document.getElementById('imagePickerUpload').addEventListener('change', handleImagePickerUpload);

            // Image Picker Search
            document.getElementById('imagePickerSearch').addEventListener('input', debounce(filterImagePicker, 300));
        }

        function updateCharCount(fieldId, countId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(countId);
            const length = field.value.length;
            
            counter.textContent = `${length}/${maxLength} Zeichen`;
            
            if (length > maxLength * 0.9) {
                counter.className = 'char-count error';
            } else if (length > maxLength * 0.7) {
                counter.className = 'char-count warning';
            } else {
                counter.className = 'char-count';
            }
        }

        function updateSlug() {
            const title = document.getElementById('title').value;
            const slug = title
                .toLowerCase()
                .replace(/[äöüß]/g, function(match) {
                    const replacements = {'ä': 'ae', 'ö': 'oe', 'ü': 'ue', 'ß': 'ss'};
                    return replacements[match];
                })
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
            
            document.getElementById('slug').value = slug;
            updateSEOPreview();
        }

        function addTag(tagName) {
            if (tagName && !currentTags.includes(tagName)) {
                currentTags.push(tagName);
                updateTagsDisplay();
            }
        }

        function removeTag(tagName) {
            currentTags = currentTags.filter(tag => tag !== tagName);
            updateTagsDisplay();
        }

        function updateTagsDisplay() {
            const container = document.getElementById('tagsDisplay');
            container.innerHTML = '';
            
            currentTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag';
                tagElement.innerHTML = `
                    ${tag}
                    <button type="button" class="tag-remove" onclick="removeTag('${tag}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(tagElement);
            });

            document.getElementById('tags').value = currentTags.join(',');
        }

        function updateSEOPreview() {
            const title = document.getElementById('title').value || 'Ihr Artikel-Titel';
            const metaTitle = document.getElementById('metaTitle').value || title;
            const slug = document.getElementById('slug').value || 'artikel-url';
            const excerpt = document.getElementById('excerpt').value;
            const metaDescription = document.getElementById('metaDescription').value || excerpt || 'Ihre Meta-Description wird hier angezeigt...';

            document.getElementById('previewTitle').textContent = metaTitle;
            document.getElementById('previewUrl').textContent = `https://ihreblog.de/${slug}`;
            document.getElementById('previewDescription').textContent = metaDescription;

            updateSEOScores();
        }

        function updateSEOScores() {
            const title = document.getElementById('title').value;
            const content = editor ? editor.getContent({format: 'text'}) : '';
            const focusKeyword = document.getElementById('focusKeyword').value.toLowerCase();

            // Titel Score
            let titleScore = 0;
            if (title.length >= 30 && title.length <= 60) titleScore += 50;
            if (focusKeyword && title.toLowerCase().includes(focusKeyword)) titleScore += 50;

            // Content Score
            let contentScore = 0;
            const wordCount = content.split(/\s+/).length;
            if (wordCount >= 300) contentScore += 40;
            if (wordCount >= 600) contentScore += 30;
            if (focusKeyword && content.toLowerCase().includes(focusKeyword)) {
                const keywordDensity = (content.toLowerCase().split(focusKeyword).length - 1) / wordCount * 100;
                if (keywordDensity >= 0.5 && keywordDensity <= 2.5) contentScore += 30;
            }

            // Gesamt SEO Score
            const seoScore = Math.round((titleScore + contentScore) / 2);

            // Update UI
            updateScoreDisplay('titleScore', titleScore);
            updateScoreDisplay('contentScore', contentScore);
            updateScoreDisplay('seoScore', seoScore);
        }

        function updateScoreDisplay(elementId, score) {
            const element = document.getElementById(elementId);
            element.textContent = score;
            
            element.className = 'score-value ';
            if (score >= 80) element.className += 'score-good';
            else if (score >= 60) element.className += 'score-warning';
            else element.className += 'score-error';
        }

        function updateLivePreview() {
            const title = document.getElementById('title').value || 'Artikel-Titel';
            const category = document.getElementById('category').value || 'Kategorie';
            const status = document.getElementById('status').value;
            const content = editor ? editor.getContent() : '<p>Ihr Artikel-Inhalt wird hier in Echtzeit angezeigt...</p>';

            document.getElementById('liveTitle').textContent = title;
            document.getElementById('liveCategory').textContent = category;
            document.getElementById('liveContent').innerHTML = content;
            document.getElementById('liveDate').textContent = new Date().toLocaleDateString('de-DE');

            // Status Update
            const statusElement = document.getElementById('liveStatus');
            if (status === 'published') {
                statusElement.className = 'status-indicator status-published';
                statusElement.innerHTML = '<i class="fas fa-check"></i> Veröffentlicht';
            } else {
                statusElement.className = 'status-indicator status-draft';
                statusElement.innerHTML = '<i class="fas fa-edit"></i> Entwurf';
            }
        }

        function updateSEOAnalysis() {
            setTimeout(updateSEOScores, 100);
        }

        async function savePost(status) {
            const formData = new FormData();
            
            // Sammle alle Formulardaten
            const postData = {
                id: currentPostId || Date.now().toString(),
                title: document.getElementById('title').value,
                slug: document.getElementById('slug').value,
                excerpt: document.getElementById('excerpt').value,
                content: editor.getContent(),
                category: document.getElementById('category').value,
                tags: currentTags,
                featured_image: document.getElementById('featuredImage').value,
                meta_title: document.getElementById('metaTitle').value,
                meta_description: document.getElementById('metaDescription').value,
                focus_keyword: document.getElementById('focusKeyword').value,
                status: status,
                publish_date: document.getElementById('publishDate').value || null,
                created_at: isEditing ? null : new Date().toISOString(),
                updated_at: new Date().toISOString()
            };

            // Validierung
            if (!postData.title.trim()) {
                showMessage('Bitte geben Sie einen Titel ein.', 'error');
                return;
            }

            try {
                showMessage('Speichere...', 'info');
                
                // API Call - Integration mit bestehender API
                const response = await fetch('../api/posts.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: isEditing ? 'update' : 'create',
                        post: postData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showMessage(`Artikel erfolgreich ${status === 'published' ? 'veröffentlicht' : 'gespeichert'}!`, 'success');
                    
                    if (!isEditing) {
                        // Neue Post - ID setzen und Edit-Modus aktivieren
                        currentPostId = result.post_id;
                        isEditing = true;
                        
                        // URL aktualisieren ohne Reload
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('edit', currentPostId);
                        window.history.replaceState({}, '', newUrl);
                    }

                    // Sitemap regenerieren
                    await regenerateSitemap();
                    
                } else {
                    showMessage(`Fehler beim Speichern: ${result.error}`, 'error');
                }

            } catch (error) {
                console.error('Save error:', error);
                showMessage('Fehler beim Speichern. Bitte versuchen Sie es erneut.', 'error');
            }
        }

        async function regenerateSitemap() {
            try {
                await fetch('../generate-sitemap.php');
            } catch (error) {
                console.log('Sitemap regeneration failed:', error);
            }
        }

        async function loadPostForEditing(postId) {
            try {
                const response = await fetch(`../api/posts.php?action=get&id=${postId}`);
                const result = await response.json();

                if (result.success && result.post) {
                    const post = result.post;
                    
                    // Formular füllen
                    document.getElementById('title').value = post.title || '';
                    document.getElementById('slug').value = post.slug || '';
                    document.getElementById('excerpt').value = post.excerpt || '';
                    document.getElementById('category').value = post.category || '';
                    document.getElementById('featuredImage').value = post.featured_image || '';
                    document.getElementById('metaTitle').value = post.meta_title || '';
                    document.getElementById('metaDescription').value = post.meta_description || '';
                    document.getElementById('focusKeyword').value = post.focus_keyword || '';
                    document.getElementById('status').value = post.status || 'draft';
                    
                    if (post.publish_date) {
                        document.getElementById('publishDate').value = post.publish_date;
                    }

                    // Tags laden
                    if (post.tags && Array.isArray(post.tags)) {
                        currentTags = [...post.tags];
                        updateTagsDisplay();
                    }

                    // Content laden (nach TinyMCE Init)
                    if (editor) {
                        editor.setContent(post.content || '');
                    } else {
                        setTimeout(() => {
                            if (editor) editor.setContent(post.content || '');
                        }, 1000);
                    }

                    // Edit-Modus aktivieren
                    isEditing = true;
                    currentPostId = postId;

                    // Character Counts aktualisieren
                    updateCharCount('title', 'titleCount', 60);
                    updateCharCount('excerpt', 'excerptCount', 160);
                    updateCharCount('metaTitle', 'metaTitleCount', 60);
                    updateCharCount('metaDescription', 'metaDescCount', 160);

                    // Preview aktualisieren
                    setTimeout(() => {
                        updateSEOPreview();
                        updateLivePreview();
                    }, 1000);

                    showMessage('Artikel geladen!', 'success');
                    
                } else {
                    showMessage('Artikel konnte nicht geladen werden.', 'error');
                }

            } catch (error) {
                console.error('Load error:', error);
                showMessage('Fehler beim Laden des Artikels.', 'error');
            }
        }

        function showMessage(message, type) {
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.innerHTML = `<div class="${type}-message">${message}</div>`;
            
            // Auto-hide nach 3 Sekunden
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // Auto-Save Funktion (alle 30 Sekunden)
        let autoSaveTimer;
        function resetAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                if (document.getElementById('title').value.trim()) {
                    savePost('draft');
                }
            }, 30000);
        }

        // Auto-Save bei Änderungen
        document.addEventListener('input', resetAutoSave);

        // Tastenkürzel
        document.addEventListener('keydown', function(e) {
            // Ctrl+S / Cmd+S für Speichern
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                savePost('draft');
            }
            
            // Ctrl+Shift+P / Cmd+Shift+P für Veröffentlichen
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'P') {
                e.preventDefault();
                savePost('published');
            }
        });

        // Warn vor dem Verlassen bei ungespeicherten Änderungen
        let hasUnsavedChanges = false;

        function markAsChanged() {
            hasUnsavedChanges = true;
        }

        function markAsSaved() {
            hasUnsavedChanges = false;
        }

        // Event Listeners für Änderungen
        document.addEventListener('input', markAsChanged);

        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // Überride Save Functions um Changes zu markieren
        const originalSavePost = savePost;
        savePost = async function(status) {
            const result = await originalSavePost(status);
            markAsSaved();
            return result;
        };
    </script>
</body>
</html>